name: Validate MCP Server Configuration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  validate-server-json:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Validate JSON syntax
      run: |
        echo "üîç Validating server.json syntax..."
        if ! jq empty server.json > /dev/null 2>&1; then
          echo "‚ùå server.json has invalid JSON syntax"
          exit 1
        fi
        echo "‚úÖ JSON syntax valid"

    - name: Validate required fields
      run: |
        echo "üîç Validating required MCP server fields..."

        # Check required fields exist (per 2025-10-17 schema)
        REQUIRED_FIELDS=(
          ".name"
          ".version"
          ".description"
        )

        for field in "${REQUIRED_FIELDS[@]}"; do
          VALUE=$(jq -r "$field" server.json 2>/dev/null)
          if [ "$VALUE" = "null" ] || [ -z "$VALUE" ]; then
            echo "‚ùå Missing required field: $field"
            exit 1
          else
            echo "‚úÖ $field: $VALUE"
          fi
        done

        # Check remotes array has at least one entry with type and url
        REMOTE_COUNT=$(jq '.remotes | length' server.json)
        if [ "$REMOTE_COUNT" -eq 0 ]; then
          echo "‚ùå Missing remotes array or empty"
          exit 1
        fi

        REMOTE_TYPE=$(jq -r '.remotes[0].type' server.json)
        REMOTE_URL=$(jq -r '.remotes[0].url' server.json)

        if [ "$REMOTE_TYPE" = "null" ] || [ -z "$REMOTE_TYPE" ]; then
          echo "‚ùå Missing remotes[0].type"
          exit 1
        fi
        echo "‚úÖ remotes[0].type: $REMOTE_TYPE"

        if [ "$REMOTE_URL" = "null" ] || [ -z "$REMOTE_URL" ]; then
          echo "‚ùå Missing remotes[0].url"
          exit 1
        fi
        echo "‚úÖ remotes[0].url: $REMOTE_URL"

    - name: Validate URLs
      run: |
        echo "üîç Validating production URLs..."

        # Check remote URLs start with https://
        for i in $(seq 0 $(($(jq '.remotes | length' server.json) - 1))); do
          URL=$(jq -r ".remotes[$i].url" server.json)
          if [ "$URL" != "null" ] && [ ! -z "$URL" ]; then
            if [[ ! "$URL" =~ ^https:// ]]; then
              echo "‚ùå URL must use HTTPS: remotes[$i].url = $URL"
              exit 1
            fi
            echo "‚úÖ remotes[$i].url: $URL"
          fi
        done

    - name: Validate domains
      run: |
        echo "üîç Validating production domains..."

        # All remote URLs should point to paxai.app domains
        for i in $(seq 0 $(($(jq '.remotes | length' server.json) - 1))); do
          URL=$(jq -r ".remotes[$i].url" server.json)
          if [ "$URL" != "null" ] && [ ! -z "$URL" ]; then
            if [[ ! "$URL" =~ paxai\.app ]]; then
              echo "‚ö†Ô∏è  Warning: URL does not use paxai.app domain: $URL"
            else
              echo "‚úÖ remotes[$i].url uses paxai.app domain"
            fi
          fi
        done

    - name: Print summary
      run: |
        echo ""
        echo "üìã Summary"
        echo "=========================================="
        jq -r '
          "Name: \(.name)",
          "Version: \(.version)",
          "Description: \(.description)",
          "Transport: \(.remotes[0].type // "none")",
          "URL: \(.remotes[0].url // "none")"
        ' server.json
        echo "=========================================="
        echo "‚úÖ server.json validation passed!"
